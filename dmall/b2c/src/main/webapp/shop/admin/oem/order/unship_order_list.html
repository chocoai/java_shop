<#include '/admin/header.html' >
    <#assign dateFormat="com.baigu.framework.directive.DateformateDirective"?new()>
        <div  class="admin-main">
            <div>
                <!--按钮操作  -->
                <div class="table_control">
                   <div class="table_opera" style="position: relative;">
                        <button type="button" class="layui-btn layui-btn-primary " title="批量设置已发货" onclick="batchSetShipped();"><i class="icon iconfont icon-settings"></i></button>
                        <button type="button" class="layui-btn layui-btn-primary " title="导入代加工订单" onclick="importOemExcel();"><i class="icon iconfont icon-activity"></i></button>
                        <form id="oemForm" enctype="multipart/form-data" style="display: none;">
                            <input id="oemFile" type="file" name="oemfile" />
                            <input id="customerId" type="hidden" name="customerId" />
                        </form>
                        <div id="customerSelector"  class="admin-main" style="display: none; position: absolute; top:10px; left:50px; z-index: 999; width:500px;">
                            <div class="layui-form-item">
                                <label class="layui-form-label">客户名：</label>
                                <div class="layui-input-block">
                                    <select name="cname" id="customerName" class="select">
                                    </select>
                                </div>
                            </div>
                        </div>
                   </div>
                    <!--搜索区域  -->
                    <div class="table_search">
                        <input type="text" id="_search" placeholder="请输入客户名" style="height:25px;">
                        <button type="button" class="layui-btn layui-btn-primary layui-btn-small" onclick="searchOrder()"><i class="layui-icon">&#xe615;</i></button>
                    </div>
                </div>
            </div>

            <!--表格区域  -->
            <form id="subForm">
                <table id="tabledata" class="layui-table site-table table-hover" width="100%" lay-skin="line" >
                    <thead>
                    <tr>
                        <th><input type='checkbox'  class='btn-checkall fly-checkbox' id='selected-all'></th>
                        <th>订单号</th>
                        <th>客户</th>
                        <th>快递名</th>
                        <th>运费</th>
                        <th>订单价格</th>
                        <th>收货人姓名</th>
                        <th>收货人手机</th>
                        <th>收货人地址</th>
                        <th>修改时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                </table>
                <!--传值等操作(暂定)  -->
                <div id="addBrand" ></div>
            </form>
        </div>

        <!--js区域  -->
        <script>
            var index = parent.layer.getFrameIndex(window.name);

            /* 监听开始搜索按钮 */
            var table;
            var url = "${ctx}/shop/admin/oem/order/list-json.do?status=10";
            $(function(){
                table = $('#tabledata').DataTable({
                    "language": {
                        "url": "${staticserver}/media/zh_CN.txt"
                    },
                    "processing": true,
                    "serverSide": true,
                    "ordering": false,
                    "searching": false,
                    "lengthChange": false,
                    ajax: {
                        //指定数据源
                        type:"post",
                        url: url
                    },
                    columns: [ //定义列
                        {"data": function (obj) {
                            return '<input type="checkbox" name="ids" class="fly-checkbox" value=' + obj.id +'>';
                        }},
                        {data: "orderno"},
                        {data: "cname"},
                        {data: "expname"},
                        {data: "freight"},
                        {data: "price"},
                        {data: "cneename"},
                        {data: "cneephone"},
                        {data: "cneeaddr"},
                        {data: function(obj) {
                            if(obj.updatetime==null){
                                return " ";
                            }else{
                                return  getFormatDateByLong(obj.updatetime/1000, "yyyy-MM-dd hh:mm:ss");
                            }
                        }},
                        {data: null,"render": function(data, type, row) {
                            var html = "";
                            html+= "<a class='layui-btn layui-btn-small _aa' name='change_btn' onclick='setShipped(\""+data['id']+"\")'>设为已发货</a>&nbsp;";
                            html+= "<a class='layui-btn layui-btn-small _aa' name='change_btn' onclick='del(\""+data['id']+"\")'>删除</a>&nbsp;";
                            return html;
                        }}
                    ]
                });
            });

            //导入代加工Excel
            function importOemExcel(){
                $("#customerSelector").toggle();
                var options = {
                    url : "${ctx}/shop/admin/oem/customer/getCustomerList.do",
                    type : "POST",
                    dataType : 'json',
                    success : function(result) {
                        //加载客户下拉选项
                        if (result.result == 1) {
                            $("#customerName").empty();
                            $("#customerName").append("<option value=' '>-- 请选择 --</option>");
                            if(result.data && result.data.length>0){
                                $.each(result.data,function(i,data){
                                    $("#customerName").append("<option value='"+data.id+"'>"+data.name+"</option>");
                                })
                            }
                            //注册事件
                            $("#customerName").unbind().on("change",function(){
                                //弹出file
                                $("#oemFile").click();
                                $("#oemFile").unbind().on("change",function (event) {
                                    var file = this.files;
                                    var options = {
                                        url : "${ctx}/shop/admin/oem/order/importOemExcel.do",
                                        type : "POST",
                                        dataType : 'json',
                                        success : function(result) {
                                            if (result.result == 1) {
                                                $.Loading.success(result.message);
                                                table.ajax.url(url).load();
                                            }
                                            if (result.result == 0) {
                                                $.Loading.error(result.message);
                                            }
                                            //清空文件域
                                            var oemFile = document.getElementById('oemFile') ;
                                            oemFile.outerHTML=oemFile.outerHTML;

                                            //关闭弹框
                                            $("#customerSelector").hide();
                                        },
                                        error : function(e) {
                                            $.Loading.error("出现错误 ，请重试");
                                        }
                                    };
                                    var customerId = $("#customerName").val();
                                    $("#customerId").val(customerId);
                                    $("#oemForm").ajaxSubmit(options);
                                })
                            });
                        }
                        if (result.result == 0) {
                            $.Loading.error(result.message);
                        }
                    },
                    error : function(e) {
                        $.Loading.error("出现错误 ，请重试");
                    }
                };
                $.ajax(options);
            }

            function del(id){
                if(!confirm("确认删除该记录吗？")){
                    return;
                }
                var options = {
                    url : "${ctx}/shop/admin/oem/order/delete.do?id="+id,
                    type : "POST",
                    dataType : 'json',
                    success : function(result) {
                        if (result.result == 1) {
                            $.Loading.success(result.message);
                            table.ajax.url(url).load();
                        }
                        if (result.result == 0) {
                            $.Loading.error(result.message);
                        }
                    },
                    error : function(e) {
                        $.Loading.error("出现错误 ，请重试");
                    }
                };
                $.ajax(options);
            }

            /**
             * 设为已发货
             * @param id
             */
            function setShipped(id){
                if(!confirm("确认设为已发货吗？")){
                    return;
                }
                if(id){
                    id = [id];
                } else {
                    alert("参数不正确!");
                    return ;
                }
                var options = {
                    url : "${ctx}/shop/admin/oem/order/setShipped.do",
                    type : "POST",
                    data:{ids:id},
                    traditional:true,//禁用jq深度序列号，以避免传递数组变量名改变
                    dataType : 'json',
                    success : function(result) {
                        if (result.result == 1) {
                            $.Loading.success(result.message);
                            table.ajax.url(url).load();
                        }
                        if (result.result == 0) {
                            $.Loading.error(result.message);
                        }
                    },
                    error : function(e) {
                        $.Loading.error("出现错误 ，请重试");
                    }
                };
                $.ajax(options);
            }
            function batchSetShipped(){
                var check = $("input[name='ids']").is("input:checked");
                if(check == false){
                    alert("请选择至少一条记录");
                    return false;
                }
                if(!confirm("确认批量设置已发货吗？")){
                    return;
                }
                var options = {
                    url : "${ctx}/shop/admin/oem/order/setShipped.do",
                    type : "POST",
                    dataType : 'json',
                    success : function(result) {
                        if (result.result == 1) {
                            $.Loading.success(result.message);
                            table.ajax.url(url).load();
                        }
                        if (result.result == 0) {
                            $.Loading.error(result.message);
                        }
                    },
                    error : function(e) {
                        $.Loading.error("出现错误 ，请重试");
                    }
                };
                $("#subForm").ajaxSubmit(options);
            }

            //普通搜索
            function searchOrder(){
                var keyword = $("#_search").val();
                table.ajax.url(url+"&keyword="+keyword).load();
            }
        </script>
        <#include '/admin/footer.html' >
